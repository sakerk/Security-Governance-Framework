<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Data Agnostic Viewer (DAV)</title>

<!-- External config (optional). If present, must define window.DAV_CONFIG -->
<script src="config.js" defer></script>

<style>
  :root{
    --bg:#0b0f14; --panel:#0f172a; --muted:#93a1b1; --text:#e6edf3; --line:#1f2937;
    --accent:#60a5fa; --sel:#19324d; --hover:#0f2236; --danger:#ef4444; --ok:#22c55e;
    --side-width: 380px;
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  *{scrollbar-width:thin; scrollbar-color:#344256 #0b1220;}
  ::-webkit-scrollbar{width:8px;height:8px}
  ::-webkit-scrollbar-track{background:#0b1220}
  ::-webkit-scrollbar-thumb{background:#344256;border-radius:10px;border:2px solid #0b1220}
  ::-webkit-scrollbar-thumb:hover{background:#4a5e7a}

  .app{height:100vh;display:flex;flex-direction:column}
  .topbar{position:sticky;top:0;z-index:20;display:flex;gap:10px;align-items:center;padding:10px 12px;background:var(--panel);border-bottom:1px solid var(--line)}
  .title{margin:0;font-size:16px;font-weight:600;letter-spacing:.2px;white-space:nowrap}
  .spacer{flex:1}
  .search{min-width:220px;max-width:420px;width:36ch;padding:10px 12px;border-radius:12px;outline:none;border:1px solid #263241;background:#0b1220;color:var(--text)}
  .count{font-size:12px;color:var(--muted);white-space:nowrap}
  .wrap {flex:1 1 auto;min-height:0}
  .mainbar{display:flex;height:100%}
  .mainbar.side-hidden .side, .mainbar.side-hidden #gutter{display:none}
  .main{flex:1;min-width:0;padding:10px;display:flex;flex-direction:column}
  .tableScroll{flex:1;overflow:auto;background:#0b1220;border:1px solid #263241;border-radius:12px}
  table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
  th,td{padding:10px 12px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
  td{white-space:pre-wrap;overflow-wrap:anywhere}
  thead th{position:sticky;top:0;background:#0f172a;z-index:2;user-select:none}
  thead .filters th{position:sticky;top:36px;background:#0e1525;z-index:2;padding:6px 8px;border-bottom:1px solid #172233}
  thead .filters input{width:100%;box-sizing:border-box;padding:6px 8px;border-radius:8px;border:1px solid #263241;background:#0b1220;color:#e6edf3;font-size:12px}
  tbody tr.hide{display:none}
  tbody tr.selected td{background:var(--sel)}
  tbody tr:hover td{background:var(--hover)}
  tbody tr.selected:hover td{background:var(--sel)}
  th.selCol,td.selCol{width:44px;min-width:44px;max-width:44px;text-align:center}
  input[type="checkbox"]{width:16px;height:16px;cursor:pointer}

  th{position:sticky;top:0;background:#0f172a}
  th .headerInner{position:relative;display:flex;gap:6px;align-items:center;padding-right:10px;cursor:pointer}
  .sortIndicator{font-size:12px;color:#9aa6b2}
  .resizer{position:absolute;top:0;right:-4px;width:8px;height:100%;cursor:col-resize;user-select:none;
    background:linear-gradient(to right, transparent 0, transparent 3px, #1f2937 3px, #1f2937 5px, transparent 5px);
    opacity:.3}
  .resizer:hover{opacity:.6}

  .hidden-col{width:0!important;min-width:0!important;max-width:0!important;padding:0!important;border:0!important;overflow:hidden!important;clip-path:inset(0);white-space:nowrap!important;pointer-events:none;opacity:0}
  thead tr.filters th.hidden-col{height:0;padding:0!important;border:0!important}

  .controls{display:flex;gap:6px;align-items:center}
  .iconbtn{display:inline-flex;align-items:center;justify-content:center;width:34px;height:34px;border:1px solid #27415f;background:#0f213c;color:#dbeafe;border-radius:10px;cursor:pointer}
  .iconbtn[disabled]{opacity:.5;cursor:not-allowed}
  .iconbtn:hover{background:#15325d}
  .icon{width:16px;height:16px;fill:currentColor}

  .columnsWrap,.sideFieldsWrap,.exportWrap{display:flex;gap:8px;align-items:center;position:relative}
  .colsPanel{display:none;position:absolute;top:42px;right:0;z-index:1000;min-width:300px;max-height:60vh;overflow:auto;background:#0b1220;border:1px solid #263241;border-radius:12px;padding:10px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .colsPanel.open{display:block}
  .panelRow{display:flex;align-items:center;gap:8px;padding:8px 6px;border-radius:8px}
  .panelRow:hover{background:#0f213c}
  .panelRow .label{flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .colsPanel .note{margin-top:8px;color:var(--muted);font-size:12px}

  .togglebtn{position:relative;width:44px;height:24px;border-radius:999px;border:1px solid #27415f;background:#15233e;cursor:pointer}
  .togglebtn::after{content:"";position:absolute;top:2px;left:2px;width:20px;height:20px;background:#dbeafe;border-radius:50%;transition:left .15s ease}
  .togglebtn[aria-pressed="true"]{background:#2c5fa8}
  .togglebtn[aria-pressed="true"]::after{left:22px}

  .radiobtn{position:relative;width:20px;height:20px;border-radius:50%;border:1px solid #27415f;background:#15233e;cursor:pointer}
  .radiobtn[aria-checked="true"]::after{content:"";position:absolute;top:4px;left:4px;width:10px;height:10px;border-radius:50%;background:#dbeafe}
  .exportFooter{display:flex;gap:8px;justify-content:flex-end;padding-top:8px;border-top:1px solid #1a2436;margin-top:8px}

  .gutter{width:6px;cursor:col-resize;background:linear-gradient(to right, transparent 0, transparent 2px, #1f2937 2px, #1f2937 4px, transparent 4px)}
  .side{width:var(--side-width);min-width:260px;max-width:70vw;border-left:1px solid var(--line);background:#0b1220;padding:10px;overflow:auto}
  .side h2{margin:0 0 8px 0;font-size:14px}
  .side .section{margin-bottom:14px}
  .attrlist{list-style:decimal;margin:6px 0 0 20px;padding:0}
  .attrlist li{padding:4px 2px}

  .seg{display:inline-flex;border:1px solid #27415f;border-radius:12px;overflow:hidden}
  .seg button{border:0;background:#0f213c;color:#dbeafe;padding:8px 12px;cursor:pointer}
  .seg button.active{background:#13305a}

  .selectedListTitle{font-weight:600;margin:4px 2px 6px 2px;font-size:13px;color:#cbd5e1}
  .selectedList{display:flex;flex-direction:column;gap:6px;margin-bottom:8px}
  .selectedItem{display:flex;align-items:center;gap:8px;padding:6px 8px;border:1px dashed #2a3a55;border-radius:8px;background:#0e1a30}
  .drag{width:16px;height:16px;opacity:.7}
  .selectedItem .name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

  @media (max-width:900px){
    .title{display:none}
    .search{flex:1;min-width:0;width:auto}
    .side{display:none}.gutter{display:none}
  }

  .modalBackdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
  .modalBackdrop.open{display:flex}
  .modal{width:min(900px,92vw);max-height:88vh;overflow:auto;background:var(--panel);border:1px solid var(--line);border-radius:14px;box-shadow:0 20px 60px rgba(0,0,0,.5)}
  .modal header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line)}
  .modal h2{margin:0;font-size:16px}
  .modal .content{padding:14px 16px}
  .modal .grid{display:grid;grid-template-columns:200px 1fr;gap:10px 14px;align-items:start}
  .modal label{color:var(--muted);font-size:13px;padding-top:10px}
  .modal input,.modal textarea,.modal select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #263241;background:#0b1220;color:#e6edf3}
  .modal footer{display:flex;gap:10px;justify-content:flex-end;padding:14px 16px;border-top:1px solid var(--line)}
  .help{color:var(--muted);font-size:12px;margin-top:8px}
  .msg{font-size:13px;margin-right:auto}
  .msg.ok{color:var(--ok)} .msg.err{color:var(--danger)}
  @media (max-width:900px){ .modal .grid{grid-template-columns:1fr} .modal label{padding-top:0} }
</style>
</head>
<body>
<div class="app">
  <header class="topbar">
    <h1 id="pageTitle" class="title">Data Agnostic Viewer (DAV)</h1>

    <div class="seg" role="tablist" aria-label="View mode">
      <button id="modeMd" role="tab" aria-selected="true">MD</button>
      <button id="modeJson" role="tab" aria-selected="false">JSON</button>
    </div>

    <input id="q" class="search" type="search" placeholder="Searchâ€¦" aria-label="Search table"/>

    <div class="columnsWrap">
      <button id="colsBtn" class="iconbtn" title="Columns" aria-haspopup="true" aria-expanded="false">
        <svg class="icon" viewBox="0 0 16 16" aria-hidden="true"><path d="M1.5 3.75A.75.75 0 0 1 2.25 3h11.5a.75.75 0 0 1 .54 1.28L9.5 9.06v3.69a.75.75 0 0 1-1.14.64l-2-1.25a.75.75 0 0 1-.36-.64V9.06L1.71 4.28A.75.75 0 0 1 1.5 3.75Z"/></svg>
      </button>
      <div id="colsPanel" class="colsPanel" role="dialog" aria-label="Toggle table columns"></div>
    </div>

    <div class="controls">
      <div class="sideFieldsWrap">
        <button id="sideColsBtn" class="iconbtn" title="Attribute Fields" aria-haspopup="true" aria-expanded="false">
          <svg class="icon" viewBox="0 0 16 16" aria-hidden="true"><path d="M2.75 3a.75.75 0 0 1 0-1.5h6.5a.75.75 0 0 1 0 1.5h-6.5ZM2 4.75c0-.414.336-.75.75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5A.75.75 0 0 1 2 4.75Zm0 7.5c0-.414.336-.75.75-.75h6.5a.75.75 0 0 1 0 1.5h-6.5A.75.75 0 0 1 2 12.25Zm11.25-4.5a.75.75 0 0 0 0-1.5H7.75a.75.75 0 0 0 0 1.5h5.5Z"/></svg>
        </button>
        <div id="sideColsPanel" class="colsPanel" role="dialog" aria-label="Choose & order fields for Attribute Panel"></div>
      </div>

      <button id="addBtn" class="iconbtn" title="Add row" aria-label="Add row">
        <svg class="icon" viewBox="0 0 16 16"><path d="M8 1a.75.75 0 0 1 .75.75v5.5h5.5a.75.75 0 0 1 0 1.5h-5.5v5.5a.75.75 0 0 1-1.5 0v-5.5h-5.5a.75.75 0 0 1 0-1.5h5.5v-5.5A.75.75 0 0 1 8 1Z"/></svg>
      </button>
      <button id="editBtn" class="iconbtn" title="Edit selected row" aria-label="Edit selected row" disabled>
        <svg class="icon" viewBox="0 0 16 16"><path d="M11.013 1.427a1.75 1.75 0 0 1 2.475 2.475l-7.7 7.7a1.75 1.75 0 0 1-.74.436l-3.023.887a.5.5 0 0 1-.62-.62l.887-3.024a1.75 1.75 0 0 1 .436-.739l7.7-7.7Zm.53 3.005-1.975-1.975-7.43 7.43a.25.25 0 0 0-.062.106l-.66 2.25 2.25-.66a.25.25 0 0 0 .106-.062l7.43-7.43Z"/></svg>
      </button>
      <button id="copyBtn" class="iconbtn" title="Copy (uses chosen export format)" aria-label="Copy (uses chosen export format)" disabled>
        <svg class="icon" viewBox="0 0 16 16"><path d="M3.75 2A1.75 1.75 0 0 0 2 3.75v7.5C2 12.216 2.784 13 3.75 13h5.5A1.75 1.75 0 0 0 11 11.25v-7.5C11 2.784 10.216 2 9.25 2h-5.5Zm0 1.5h5.5a.25.25 0 0 1 .25.25v7.5a.25.25 0 0 1-.25.25h-5.5a.25.25 0 0 1-.25-.25v-7.5a.25.25 0 0 1 .25-.25ZM13 4.75a.75.75 0 0 1 1.5 0v7.5A2.75 2.75 0 0 1 11.75 15h-7.5a.75.75 0 0 1 0-1.5h7.5c.69 0 1.25-.56 1.25-1.25v-7.5Z"/></svg>
      </button>

      <div class="exportWrap">
        <button id="exportBtn" class="iconbtn" title="Export">
          <svg class="icon" viewBox="0 0 16 16"><path d="M7.25 1.75a.75.75 0 0 1 1.5 0V9l2.22-2.22a.75.75 0 1 1 1.06 1.06l-3.5 3.5a.75.75 0 0 1-1.06 0l-3.5-3.5A.75.75 0 1 1 5.03 6.78L7.25 9V1.75ZM2 12.25a.75.75 0 0 1 .75-.75h10.5a.75.75 0 0 1 0 1.5H2.75a.75.75 0 0 1-.75-.75Z"/></svg>
        </button>
        <div id="exportPanel" class="colsPanel" role="dialog" aria-label="Choose export format and export"></div>
      </div>
    </div>

    <div class="spacer"></div>
    <span id="count" class="count" aria-live="polite"></span>

    <button id="toggleSideBtn" class="iconbtn" title="Show/Hide Attribute Panel" aria-label="Show/Hide Attribute Panel" aria-pressed="true" style="margin-left:6px;">
      <svg class="icon" viewBox="0 0 16 16" aria-hidden="true"><path d="M2.75 2A1.75 1.75 0 0 0 1 3.75v8.5C1 13.216 1.784 14 2.75 14h10.5A.75.75 0 0 0 15 12.25v-8.5C15 2.784 14.216 2 13.25 2H2.75Zm7.75 1.5h2.75a.25.25 0 0 1 .25.25v8.5a.25.25 0 0 1-.25.25H10.5V3.5Zm-1.5 0H2.75a.25.25 0 0 0-.25.25v8.5c0 .138.112.25.25.25H9V3.5Z"/></svg>
    </button>
  </header>

  <div class="wrap">
    <div class="mainbar">
      <div class="main">
        <div class="tableScroll">
          <table id="sheet"><colgroup id="colgroup"><col class="col-sel"></colgroup></table>
        </div>
      </div>
      <div id="gutter" class="gutter" title="Drag to resize Attribute Panel" aria-hidden="true"></div>
      <aside class="side" aria-label="Attribute Panel">
        <h2>Attribute Panel</h2>
        <div id="attrContainer"></div>
      </aside>
    </div>
  </div>
</div>

<!-- Add/Edit Modal (UI kept; save/write logic omitted here for brevity) -->
<div id="addModal" class="modalBackdrop" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal" role="document">
    <header>
      <h2 id="formTitle">Add Row</h2>
      <button id="addClose" class="iconbtn" aria-label="Close">
        <svg class="icon" viewBox="0 0 16 16"><path d="M3.72 3.72a.75.75 0 0 1 1.06 0L8 6.94l3.22-3.22a.75.75 0 0 1 1.06 1.06L9.06 8l3.22 3.22a.75.75 0 0 1-1.06 1.06L8 9.06l-3.22 3.22a.75.75 0 1 1-1.06-1.06L6.94 8 3.72 4.78a.75.75 0 0 1 0-1.06z"/></svg>
      </button>
    </header>
    <div class="content">
      <form id="addForm"><div id="addGrid" class="grid"></div><p class="help">All fields are optional.</p></form>
    </div>
    <footer>
      <div id="addMsg" class="msg" aria-live="polite"></div>
      <button id="addSave" class="iconbtn" title="Save">
        <svg class="icon" viewBox="0 0 16 16"><path d="M2.75 2A1.75 1.75 0 0 0 1 3.75v8.5C1 13.216 1.784 14 2.75 14h10.5A1.75 1.75 0 0 0 15 12.25V5.06c0-.464-.184-.909-.513-1.237L12.176 1.51A1.75 1.75 0 0 0 10.94 1H2.75ZM10 2.5h.94c.2 0 .39.079.53.22l2.06 2.06V12.25a.25.25 0 0 1-.25.25H2.75a.25.25 0 0 1-.25-.25v-8.5a.25.25 0 0 1 .25-.25H10V6a1 1 0 1 0 2 0V2.5Z"/></svg>
      </button>
    </footer>
  </div>
</div>

<script>
/* ---------- Config ---------- */
var CFG = {};
var SRC = {};
var ACTIVE_BRANCH = "main";

function autoDetectFromLocation(){
  var host = location.hostname;                         // e.g., sakerk.github.io
  var owner = host.slice(-10)===".github.io" ? host.replace(".github.io","") : "";
  // IMPORTANT FIX: remove empty segments properly
  var parts = location.pathname.replace(/\/index\.html$/,"").replace(/\/$/,"").split("/")
              .filter(function(s){ return s && s.trim() !== ""; });
  // e.g., [ "Security-Governance-Framework", "MPA_5.3.1_Controls" ]
  var repo  = parts[0] || "";
  var dataDir = parts.slice(1).join("/");               // "MPA_5.3.1_Controls"
  if(owner && repo){
    return {
      title: document.title || "DAV",
      source: { type:"github", owner: owner, repo: repo, branch:"main", dataDir: dataDir },
      permissions: { write:false },
      ui: { startMode: "md" }
    };
  }
  return null;
}

function resolveConfigSync(){
  if (window.DAV_CONFIG && typeof window.DAV_CONFIG === "object") {
    CFG = window.DAV_CONFIG;
  } else {
    var auto = autoDetectFromLocation();
    CFG = auto || { title:"DAV", source:{type:"github", owner:"", repo:"", branch:"main", dataDir:""}, permissions:{write:false}, ui:{startMode:"md"} };
  }
  SRC = CFG.source || {};
  ACTIVE_BRANCH = SRC.branch || "main";
  document.title = CFG.title || "DAV";
  var t = document.getElementById("pageTitle"); if(t) t.textContent = CFG.title || "DAV";
}

/* --------------------- State --------------------- */
var GH_TOKEN  = localStorage.getItem("ghToken") || "";
var VIEW_MODE = localStorage.getItem("viewMode") || ((CFG.ui && (CFG.ui.startMode==="json"||CFG.ui.startMode==="md")) ? CFG.ui.startMode : "md");
var EXPORT_FMT = localStorage.getItem("dav:exportFmt") || "md";
function CAN_WRITE(){ return !!(CFG.permissions && CFG.permissions.write && SRC.type==="github"); }

function VIS_KEY(mode){ return "dav:colVisible:"+mode; }
function WIDTH_KEY(mode){ return "dav:colWidths:"+mode; }
var SIDE_VISIBLE_KEY = "dav:sideVisible";
function SIDE_COLS_KEY_FN(mode){ return "dav:sideCols:"+mode; }

var HEADERS=[], ROWS=[], FILES=[];
var SELECTED = new Set();
var COL_VISIBLE=[], COL_WIDTHS=[];
var INDEX_ROWS=[];
var SORT_COL=-1, SORT_DIR=1;
var FILTERS = [];
var HOVER_INDEX = -1;
var SIDE_COLS = [];

/* --------------------- GitHub helpers --------------------- */
function ghContentsUrl(dir){
  return "https://api.github.com/repos/"+encodeURIComponent(SRC.owner)+"/"+encodeURIComponent(SRC.repo)+"/contents/"+encodeURIComponent(dir||"")+"?ref="+encodeURIComponent(ACTIVE_BRANCH);
}
function ghRawUrl(path){ return "https://raw.githubusercontent.com/"+SRC.owner+"/"+SRC.repo+"/"+ACTIVE_BRANCH+"/"+path; }

async function ghList(dir){
  var url = ghContentsUrl(dir);
  var res = await fetch(url);
  if(!res.ok && GH_TOKEN){ res = await fetch(url, {headers:{Authorization:"Bearer "+GH_TOKEN}}); }
  if(!res.ok){
    if ((ACTIVE_BRANCH==="main" || ACTIVE_BRANCH==="master")){
      var alt = ACTIVE_BRANCH==="main" ? "master" : "main";
      var altUrl = url.replace(/ref=[^&]+/, "ref="+encodeURIComponent(alt));
      var res2 = await fetch(altUrl);
      if(!res2.ok && GH_TOKEN){ res2 = await fetch(altUrl, {headers:{Authorization:"Bearer "+GH_TOKEN}}); }
      if(res2.ok){ ACTIVE_BRANCH = alt; console.warn("Branch fallback to", ACTIVE_BRANCH); return res2.json(); }
    }
    throw new Error("GitHub list error "+res.status+" at "+url);
  }
  return res.json();
}
async function ghListAll(dir){
  var entries = await ghList(dir);
  var out = [];
  for (var i=0;i<entries.length;i++){
    var it = entries[i];
    if (it.type === "file") out.push(it);
    else if (it.type === "dir") {
      var deeper = await ghListAll(it.path);
      for (var k=0;k<deeper.length;k++) out.push(deeper[k]);
    }
  }
  return out;
}
async function fetchText(url){
  var res = await fetch(url);
  if(!res.ok && GH_TOKEN){ res = await fetch(url, {headers:{Authorization:"Bearer "+GH_TOKEN}}); }
  if(!res.ok) throw new Error("Fetch error "+res.status+" for "+url);
  return res.text();
}

/* --------------------- Parsing/cleanup helpers (unchanged) --------------------- */
function splitCells(line){
  var s=line.trim(); s=s.replace(/^\|/,"").replace(/\|$/,"");
  var parts=[]; var cur=""; var esc=false;
  for(var i=0;i<s.length;i++){
    var ch=s[i];
    if(esc){ cur+=ch; esc=false; continue; }
    if(ch==="\\"){ esc=true; continue; }
    if(ch==="|"){ parts.push(cur.trim()); cur=""; continue; }
    cur+=ch;
  }
  parts.push(cur.trim()); return parts;
}
function parseFirstTable(md){
  var lines=md.split(/\r?\n/);
  for(var i=0;i<lines.length-1;i++){
    var headerLine=lines[i], sepLine=lines[i+1]||"";
    if(/^\s*\|.*\|\s*$/.test(headerLine) && /^\s*\|\s*:?-{3,}.*\|\s*$/.test(sepLine)){
      var headers=splitCells(headerLine), rows=[];
      for(var j=i+2;j<lines.length;j++){
        var ln=lines[j]; if(!/^\s*\|.*\|\s*$/.test(ln)) break;
        var cells=splitCells(ln);
        var allEmpty=true; for(var c=0;c<cells.length;c++){ if(cells[c].trim()!==""){allEmpty=false;break;} }
        if(allEmpty) continue;
        rows.push(cells);
      }
      return { headers: headers, rows: rows };
    }
  }
  return null;
}
function isObj(v){ return v && typeof v==='object' && !Array.isArray(v); }
function cleanBulletLines(text){
  if(text==null) return "";
  var raw = String(text);
  raw = raw.replace(/<br\s*\/?>/gi, "\n").replace(/<\/?[^>]+>/g, "").replace(/&nbsp;/gi, " ").replace(/\r/g, "");
  var lines = raw.split(/\n+/).map(function(s){ return s.trim(); }).filter(function(s){return !!s;});
  if(lines.length<=1) return raw.trim();
  var cleaned = lines.map(function(l){
    return l.replace(/^[-*â€¢â€“â€”]\s+/,"").replace(/^\d+[\.\)]\s+/,"").replace(/^\(\d+\)\s+/,"").replace(/^- \[[ xX]\]\s+/,"");
  });
  return cleaned.map(function(l,i){ return (i+1)+". "+l; }).join("\n");
}
function flattenJson(obj){
  var out={};
  Object.keys(obj||{}).forEach(function(k){
    var v = obj[k];
    if(isObj(v)){
      if(String(k).toLowerCase() === "data"){
        Object.keys(v).forEach(function(k2){
          var v2 = v[k2];
          out[k2] = isObj(v2) ? JSON.stringify(v2) : Array.isArray(v2) ? cleanBulletLines(v2.join("\n")) : cleanBulletLines(v2);
        });
      } else {
        Object.keys(v).forEach(function(k2){
          var v2 = v[k2];
          out[k+"."+k2] = isObj(v2) ? JSON.stringify(v2) : Array.isArray(v2) ? cleanBulletLines(v2.join("\n")) : cleanBulletLines(v2);
        });
      }
    } else if(Array.isArray(v)){
      out[k] = cleanBulletLines(v.join("\n"));
    } else {
      out[k] = cleanBulletLines(v);
    }
  });
  return out;
}
function rowFromFlatGrowHeaders(flat){
  if(HEADERS.length===0){
    HEADERS = Object.keys(flat);
    COL_VISIBLE = HEADERS.map(function(){ return true; });
    COL_WIDTHS  = HEADERS.map(function(){ return null; });
    return HEADERS.map(function(h){ return (flat[h] != null ? flat[h] : ""); });
  }
  var oldHeaders = HEADERS.slice();
  Object.keys(flat).forEach(function(k){ if(HEADERS.indexOf(k)===-1) HEADERS.push(k); });
  if(HEADERS.length !== oldHeaders.length){
    ROWS = ROWS.map(function(r){
      var map={};
      for(var i=0;i<oldHeaders.length;i++){ var h=oldHeaders[i]; map[h]= (r[i] != null ? r[i] : ""); }
      return HEADERS.map(function(h){ return (map[h] != null ? map[h] : ""); });
    });
    while(COL_VISIBLE.length < HEADERS.length) COL_VISIBLE.push(true);
    while(COL_WIDTHS.length  < HEADERS.length) COL_WIDTHS.push(null);
  }
  return HEADERS.map(function(h){ return (flat[h] != null ? flat[h] : ""); });
}
function hideDefaultsIfFresh(){
  var saved = localStorage.getItem(VIS_KEY(VIEW_MODE));
  if(saved) return;
  COL_VISIBLE = HEADERS.map(function(){ return true; });
}

/* --------------------- Attribute Panel + Columns UI (unchanged) --------------------- */
function restoreSideCols(){
  var saved = localStorage.getItem(SIDE_COLS_KEY_FN(VIEW_MODE));
  if(saved){
    try{
      var arr = JSON.parse(saved);
      if(Array.isArray(arr)) { SIDE_COLS = arr.filter(function(h){ return HEADERS.indexOf(h)!==-1; }); return; }
    }catch(e){}
  }
  SIDE_COLS = [];
}
function saveSideCols(){ try{ localStorage.setItem(SIDE_COLS_KEY_FN(VIEW_MODE), JSON.stringify(SIDE_COLS)); }catch(e){} }

function updateAttributePanel(){
  var container = document.getElementById("attrContainer");
  if(!container) return;
  container.innerHTML = "";

  var idx = (HOVER_INDEX >= 0) ? HOVER_INDEX : (SELECTED.size === 1 ? Array.from(SELECTED)[0] : -1);
  if(idx < 0 || !ROWS[idx]){
    var msg = document.createElement("div");
    msg.className = "section";
    msg.innerHTML = "<em>Hover a row to preview, or select one.</em>";
    container.appendChild(msg);
    return;
  }

  var fields = SIDE_COLS.slice();
  if(fields.length === 0){
    var info = document.createElement("div");
    info.className = "section";
    info.innerHTML = "<em>No fields selected for Attribute Panel.</em>";
    container.appendChild(info);
    return;
  }

  for(var f=0; f<fields.length; f++){
    var name = fields[f];
    var ci = HEADERS.indexOf(name);
    if(ci < 0) continue;
    var raw = (ROWS[idx][ci] != null ? ROWS[idx][ci] : "");

    var sec = document.createElement("div");
    sec.className = "section";

    var title = document.createElement("div");
    title.style.fontWeight = "600";
    title.style.marginBottom = "4px";
    title.textContent = name;
    sec.appendChild(title);

    var lines = String(raw).split(/\n+/).map(function(s){ return s.trim(); }).filter(function(s){return !!s;});
    if(lines.length > 1){
      var ol = document.createElement("ol");
      ol.className = "attrlist";
      lines.forEach(function(line){
        var clean = line.replace(/^[-*â€¢â€“â€”]\s+/,"").replace(/^\d+[\.\)]\s+/,"").replace(/^\(\d+\)\s+/,"").replace(/^- \[[ xX]\]\s+/,"");
        var li = document.createElement("li");
        li.textContent = clean;
        ol.appendChild(li);
      });
      sec.appendChild(ol);
    } else {
      var p = document.createElement("div");
      p.textContent = raw;
      sec.appendChild(p);
    }
    container.appendChild(sec);
  }
}

function buildSideColsPanel(){
  var panel=document.getElementById("sideColsPanel");
  panel.innerHTML=""; panel.addEventListener("click",function(e){ e.stopPropagation(); });

  var selTitle = document.createElement("div");
  selTitle.className = "selectedListTitle";
  selTitle.textContent = "Selected (drag to reorder):";
  panel.appendChild(selTitle);

  var selList = document.createElement("div");
  selList.className = "selectedList";
  panel.appendChild(selList);

  var dragFrom = -1;
  function rebuildSelected(){
    selList.innerHTML = "";
    for(var i=0;i<SIDE_COLS.length;i++){
      (function(iLocal){
        var name = SIDE_COLS[iLocal];
        var item = document.createElement("div");
        item.className = "selectedItem";
        item.setAttribute("draggable","true");
        item.dataset.index = String(iLocal);

        var drag = document.createElementNS("http://www.w3.org/2000/svg","svg");
        drag.setAttribute("viewBox","0 0 16 16");
        drag.classList.add("drag");
        drag.innerHTML = '<path fill="currentColor" d="M5 3h2v2H5V3Zm4 0h2v2H9V3ZM5 7h2v2H5V7Zm4 0h2v2H9V7ZM5 11h2v2H5v-2Zm4 0h2v2H9v-2Z"/>';
        item.appendChild(drag);

        var label = document.createElement("div");
        label.className = "name";
        label.textContent = name;
        item.appendChild(label);

        item.addEventListener("dragstart", function(){ dragFrom = iLocal; });
        item.addEventListener("dragover", function(e){ e.preventDefault(); });
        item.addEventListener("drop", function(e){
          e.preventDefault();
          var to = iLocal;
          if(dragFrom===-1 || dragFrom===to) return;
          var arr = SIDE_COLS.slice();
          var m = arr.splice(dragFrom,1)[0];
          arr.splice(to,0,m);
          SIDE_COLS = arr;
          saveSideCols();
          rebuildSelected();
          updateAttributePanel();
        });

        selList.appendChild(item);
      })(i);
    }
  }
  rebuildSelected();

  var divider = document.createElement("div");
  divider.className = "selectedListTitle";
  divider.textContent = "Available fields:";
  panel.appendChild(divider);

  var chosen = new Set(SIDE_COLS);
  HEADERS.forEach(function(h){
    var row=document.createElement("div"); row.className="panelRow";
    var label=document.createElement("span"); label.className="label"; label.textContent=h||"Column";
    var btn=document.createElement("button"); btn.className="togglebtn";
    var isOn = chosen.has(h);
    btn.setAttribute("aria-pressed", isOn ? "true" : "false");
    btn.title = (isOn ? "Remove from" : "Add to") + " Attribute Panel";
    btn.addEventListener("click", function(){
      var now = btn.getAttribute("aria-pressed")!=="true";
      btn.setAttribute("aria-pressed", now?"true":"false");
      if(now){
        chosen.add(h);
        SIDE_COLS.push(h);
      } else {
        chosen.delete(h);
        SIDE_COLS = SIDE_COLS.filter(function(x){ return x!==h; });
      }
      saveSideCols(); updateAttributePanel(); rebuildSelected();
      btn.title = (now ? "Remove from" : "Add to") + " Attribute Panel";
    });
    row.appendChild(label); row.appendChild(btn); panel.appendChild(row);
  });

  var note=document.createElement("div"); note.className="note";
  note.textContent="Pick which fields show on the right, and drag the selected list to set their order (saved per mode).";
  panel.appendChild(note);
}
(function setupSideColsUIOnce(){
  var btn=document.getElementById("sideColsBtn"); var panel=document.getElementById("sideColsPanel");
  btn.addEventListener("click",function(e){ e.stopPropagation(); var open=panel.classList.toggle("open"); btn.setAttribute("aria-expanded", open?"true":"false"); });
  document.addEventListener("click",function(e){ if(!panel.contains(e.target) && !btn.contains(e.target)) panel.classList.remove("open"); });
})();

/* --------------------- Table rendering, columns, sort, resize, export (unchanged) --------------------- */
var COL_VISIBLE=[], COL_WIDTHS=[];
var FILTERS=[];
var SORT_COL=-1,SORT_DIR=1;
var SELECTED=new Set();
var INDEX_ROWS=[];

function buildColumnsPanel(){ /* ... unchanged from previous message ... */ }
function applyColumnVisibility(saveFlag){ /* ... unchanged ... */ }
function applyColumnWidths(){ /* ... unchanged ... */ }
function saveColState(){ try{
  localStorage.setItem(VIS_KEY(VIEW_MODE), JSON.stringify(COL_VISIBLE));
  localStorage.setItem(WIDTH_KEY(VIEW_MODE), JSON.stringify(COL_WIDTHS));
}catch(e){} }
function restoreColState(){ try{
  var vis=JSON.parse(localStorage.getItem(VIS_KEY(VIEW_MODE))||"null");
  var wds=JSON.parse(localStorage.getItem(WIDTH_KEY(VIEW_MODE))||"null");
  if(Array.isArray(vis)&&vis.length===HEADERS.length) COL_VISIBLE=vis; else COL_VISIBLE=HEADERS.map(function(){ return true; });
  if(Array.isArray(wds)&&wds.length===HEADERS.length) COL_WIDTHS=wds; else COL_WIDTHS=HEADERS.map(function(){ return null; });
}catch(e){ COL_VISIBLE=HEADERS.map(function(){ return true; }); COL_WIDTHS=HEADERS.map(function(){ return null; }); } }
function startResize(i,ev){ /* ... unchanged ... */ }
function onResizeMove(ev){ /* ... unchanged ... */ }
function endResize(){ /* ... unchanged ... */ }
function autoFitColumn(i){ /* ... unchanged ... */ }

function renderTable(headers, rows){ /* ... unchanged from previous message ... */ }
function setRowSelection(idx,on,multi){ /* ... unchanged ... */ }
function toggleSelectVisible(on,forceMulti){ /* ... unchanged ... */ }
function updateActionButtons(){ /* ... unchanged ... */ }
function updateCounts(){ /* ... unchanged ... */ }
function buildIndexRows(){ /* ... unchanged ... */ }
function applySearchAndFilters(){ /* ... unchanged ... */ }
(function setupSearchOnce(){
  var q=document.getElementById("q");
  function debounce(fn,ms){ var t; return function(){ clearTimeout(t); t=setTimeout(fn,ms); }; }
  q.addEventListener("input", debounce(applySearchAndFilters,120));
})();
function onSortClick(i){ /* ... unchanged ... */ }
function reorderColumns(from,to){ /* ... unchanged ... */ }
function moveFilters(arr,from,to){ var x=arr.slice(); var v=x.splice(from,1)[0]; x.splice(to,0,v); return x; }

/* Export helpers (unchanged) */
function visibleCols(){ var idxs=[]; COL_VISIBLE.forEach(function(v,i){ if(v!==false) idxs.push(i); }); return idxs; }
function filterCols(headers,rows){ var cols=visibleCols(); return { fh: cols.map(function(i){ return headers[i]; }), fr: rows.map(function(r){ return cols.map(function(i){ return r[i]; }); }) }; }
function toMarkdown(headers,rows,title){ function esc(v){ return (v==null?"":String(v).replace(/\|/g,"\\|")); } var head="| "+headers.map(esc).join(" | ")+" |"; var sep="| "+headers.map(function(){return"---";}).join(" | ")+" |"; var body=rows.map(function(r){return"| "+r.map(esc).join(" | ")+" |";}).join("\n"); return (title?("# "+title+"\n\n"):"")+head+"\n"+sep+"\n"+body+"\n"; }
function toCSV(headers,rows){ function esc(v){ if(v==null)v=""; v=String(v); if(/[\",\n]/.test(v)) v='"'+v.replace(/"/g,'""')+'"'; return v; } var all=[headers].concat(rows); return all.map(function(r){ return r.map(esc).join(","); }).join("\r\n")+"\r\n"; }
function toJSONArray(headers,rows){ return rows.map(function(r){ var o={}; headers.forEach(function(h,i){ o[h]=(r[i]!=null?r[i]:""); }); return o; }); }
function download(name,text,mime){ var blob=new Blob([text],{type:mime}); var a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=name; a.click(); URL.revokeObjectURL(a.href); }
function escapeHtml(x){ return String(x).replace(/[&<>"]/g, function(s){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'})[s]; }); }
function exportToPDF(headers, rows, title){ var style='<style>body{font:12px/1.4 -apple-system,Segoe UI,Roboto,Helvetica,Arial;color:#111;margin:24px;}h1{font-size:18px;margin:0 0 12px 0}table{width:100%;border-collapse:collapse;table-layout:auto}th,td{border:1px solid #ccc;padding:6px 8px;text-align:left;vertical-align:top;word-break:break-word}thead th{background:#f2f4f7;white-space:nowrap;}td{white-space:pre-wrap;} .meta{color:#555;font-size:11px;margin:8px 0 16px 0}@media print{ body{margin:0;} }</style>'; var headRow="<tr>"+headers.map(function(h){return"<th>"+escapeHtml(h)+"</th>";}).join("")+"</tr>"; var bodyRows=rows.map(function(r){return"<tr>"+r.map(function(v){return"<td>"+escapeHtml(v!=null?v:"")+"</td>";}).join("")+"</tr>";}).join(""); var html='<!doctype html><html><head><meta charset="utf-8">'+style+'<title>'+escapeHtml(title||"Export")+'</title></head><body><h1>'+escapeHtml(title||"Export")+'</h1><div class="meta">Generated: '+new Date().toLocaleString()+'</div><table><thead>'+headRow+'</thead><tbody>'+bodyRows+'</tbody></table><script>window.onload=function(){try{window.print();}catch(e){}}<\/script></body></html>'; var w=window.open("", "_blank"); if(!w){ alert("Popup blocked. Please allow popups to export PDF."); return; } w.document.open(); w.document.write(html); w.document.close(); }
function slugify(s){ s=String(s||"export").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""); return s || "export"; }
function currentTitle(){ var el=document.getElementById("pageTitle"); var t=(el && el.textContent && el.textContent.trim()) || document.title || "DAV Export"; return t; }
function buildExportPanel(){ /* ... unchanged ... */ }
(function setupExportUIOnce(){ /* ... unchanged ... */ })();
function updateExportUI(){ var btn=document.getElementById("exportBtn"); if(btn) btn.title="Export ("+EXPORT_FMT.toUpperCase()+")"; updateActionButtons(); }
function doExport(){ /* ... unchanged ... */ }
document.getElementById("copyBtn").addEventListener("click", async function(){ /* ... unchanged ... */ });
function toast(msg){ var el=document.getElementById("count"); var old=el.textContent; el.textContent=msg; setTimeout(function(){ el.textContent=old; },1200); }

/* --------------------- Loaders --------------------- */
async function loadMd(){
  var countEl=document.getElementById("count");
  ROWS=[]; HEADERS=[]; FILES=[]; SELECTED.clear(); SORT_COL=-1;
  countEl.textContent="Probing GitHub (branch "+ACTIVE_BRANCH+")â€¦";

  var list=[];
  if(SRC.type==="github"){
    var items = await ghListAll(SRC.dataDir || "");
    list = items.filter(function(it){ return it.type==="file" && /\.md$/i.test(it.name); })
                .sort(function(a,b){ return a.path.localeCompare(b.path); })
                .map(function(it){ return {name: it.name, url: it.download_url || ghRawUrl(it.path), path: it.path, sha: it.sha || null}; });
  } else if(SRC.type==="list"){
    (SRC.urls||[]).forEach(function(u){ if(/\.md$/i.test(u)) list.push({name:u.split("/").pop(), url=u, path=u, sha:null}); });
  }

  for(var i=0;i<list.length;i++){
    var name=list[i].name, url=list[i].url, path=list[i].path, sha=list[i].sha;
    try{
      var text=await fetchText(url);
      var parsed=parseFirstTable(text); if(!parsed) continue;
      if(HEADERS.length===0){
        HEADERS=parsed.headers.length?parsed.headers:[];
        if(HEADERS.length===0 && parsed.rows[0]) HEADERS = parsed.rows[0].map(function(_,k){ return "Column "+(k+1); });
        COL_VISIBLE=HEADERS.map(function(){ return true; }); COL_WIDTHS=HEADERS.map(function(){ return null; });
      }
      if(parsed.rows && parsed.rows.length){
        var row=parsed.rows[0];
        var vals = HEADERS.map(function(_,idx){ return cleanBulletLines(row[idx]!=null?row[idx]:""); });
        ROWS.push(vals);
        FILES.push({name:name, url:url, path:path, sha:sha});
      }
      countEl.textContent="Loaded "+(i+1)+"/"+list.length+" (MD)";
    }catch(e){ console.warn("Skip MD",name,e); }
  }
  if(HEADERS.length===0){
    var tbl=document.getElementById("sheet");
    var where = SRC.dataDir ? SRC.dataDir : "(repo root)";
    tbl.innerHTML="<thead><tr><th>No MD data found in <code>"+where+"</code> (recursive, branch "+ACTIVE_BRANCH+").</th></tr></thead>";
    return;
  }
  renderTable(HEADERS, ROWS);
}
async function loadJson(){
  var countEl=document.getElementById("count");
  ROWS=[]; HEADERS=[]; FILES=[]; SELECTED.clear(); SORT_COL=-1;
  countEl.textContent="Probing GitHub (branch "+ACTIVE_BRANCH+")â€¦";

  var list=[];
  if(SRC.type==="github"){
    var items = await ghListAll(SRC.dataDir || "");
    list = items.filter(function(it){ return it.type==="file" && /\.json$/i.test(it.name); })
                .sort(function(a,b){ return a.path.localeCompare(b.path); })
                .map(function(it){ return {name: it.name, url: it.download_url || ghRawUrl(it.path), path: it.path, sha: it.sha || null}; });
  } else if(SRC.type==="list"){
    (SRC.urls||[]).forEach(function(u){ if(/\.json$/i.test(u)) list.push({name:u.split("/").pop(), url=u, path=u, sha:null}); });
  }

  for(var i=0;i<list.length;i++){
    var name=list[i].name, url=list[i].url, path=list[i].path, sha=list[i].sha;
    try{
      var text=await fetchText(url);
      var obj=JSON.parse(text);
      var flat=flattenJson(obj);
      var vals=rowFromFlatGrowHeaders(flat);
      ROWS.push(vals); FILES.push({name:name, url:url, path:path, sha:sha});
      countEl.textContent="Loaded "+(i+1)+"/"+list.length+" (JSON)";
    }catch(e){ console.warn("Skip JSON",name,e); }
  }
  if(HEADERS.length===0){
    var tbl=document.getElementById("sheet");
    var where = SRC.dataDir ? SRC.dataDir : "(repo root)";
    tbl.innerHTML="<thead><tr><th>No JSON data found in <code>"+where+"</code> (recursive, branch "+ACTIVE_BRANCH+").</th></tr></thead>";
    return;
  }
  renderTable(HEADERS, ROWS);
}

/* --------------------- Side panel: show/hide + gutter resize --------------------- */
function setSideVisibility(on){
  var mb = document.querySelector(".mainbar");
  mb.classList.toggle("side-hidden", !on);
  var btn = document.getElementById("toggleSideBtn");
  btn.setAttribute("aria-pressed", on ? "true" : "false");
  try{ localStorage.setItem(SIDE_VISIBLE_KEY, on ? "1":"0"); }catch(e){}
}
(function setupSide(){
  var saved = localStorage.getItem(SIDE_VISIBLE_KEY);
  setSideVisibility(saved !== "0");
  document.getElementById("toggleSideBtn").addEventListener("click", function(){
    var on = document.getElementById("toggleSideBtn").getAttribute("aria-pressed")!=="true";
    setSideVisibility(on);
  });
  var gutter = document.getElementById("gutter");
  var tracking = null;
  gutter.addEventListener("mousedown",function(e){
    e.preventDefault();
    var side = document.querySelector(".side");
    var startX = e.clientX;
    var startW = side.getBoundingClientRect().width;
    tracking = {startX:startX,startW:startW};
    document.body.style.cursor="col-resize";
    window.addEventListener("mousemove", drag);
    window.addEventListener("mouseup", stop);
  });
  function drag(e){
    if(!tracking) return;
    var dx = tracking.startX - e.clientX;
    var newW = Math.min(Math.max(260, tracking.startW + dx), Math.round(window.innerWidth*0.7));
    document.documentElement.style.setProperty("--side-width", newW+"px");
  }
  function stop(){
    window.removeEventListener("mousemove", drag);
    window.removeEventListener("mouseup", stop);
    document.body.style.cursor="";
    tracking=null;
  }
})();

/* --------------------- Mode & boot --------------------- */
function applyModeUI(){
  var mdBtn=document.getElementById("modeMd");
  var jsBtn=document.getElementById("modeJson");
  if(VIEW_MODE==="json"){ mdBtn.classList.remove("active"); mdBtn.setAttribute("aria-selected","false"); jsBtn.classList.add("active"); jsBtn.setAttribute("aria-selected","true"); }
  else { jsBtn.classList.remove("active"); jsBtn.setAttribute("aria-selected","false"); mdBtn.classList.add("active"); mdBtn.setAttribute("aria-selected","true"); }
}
document.getElementById("modeMd").addEventListener("click",function(){ VIEW_MODE="md"; localStorage.setItem("viewMode",VIEW_MODE); reloadAll(); });
document.getElementById("modeJson").addEventListener("click",function(){ VIEW_MODE="json"; localStorage.setItem("viewMode",VIEW_MODE); reloadAll(); });

async function reloadAll(){
  applyModeUI();
  var tbl=document.getElementById("sheet"); tbl.innerHTML="<thead><tr><th>Loadingâ€¦</th></tr></thead>";

  /* GUARD: if we can't detect owner/repo, don't hit the API */
  if (SRC.type==="github" && (!SRC.owner || !SRC.repo)) {
    var msg = '<thead><tr><th>Cannot auto-detect GitHub repo from URL.</th></tr></thead>'+
              '<tbody><tr><td>Either place this page under <code>https://USER.github.io/REPO/optional/subdir/</code>'+
              ' or provide a <code>config.js</code> that sets <code>window.DAV_CONFIG</code> with { source:{ type:"github", owner:"...", repo:"...", branch:"main", dataDir:"..." } }.</td></tr></tbody>';
    tbl.innerHTML = msg;
    document.getElementById("count").textContent = "Missing owner/repo (skipped API call)";
    console.warn("DAV: owner/repo missing. location.pathname =", location.pathname);
    return;
  }

  var diag = (SRC.type==="github") ? ("owner="+SRC.owner+" repo="+SRC.repo+" dir="+(SRC.dataDir||"(root)")+" branch="+ACTIVE_BRANCH) : ("list ("+((SRC.urls||[]).length)+") urls");
  document.getElementById("count").textContent = "Loading ("+diag+")â€¦";
  try{
    if(VIEW_MODE==="json") await loadJson(); else await loadMd();
  }catch(err){
    tbl.innerHTML="<thead><tr><th>Error</th></tr></thead><tbody><tr><td>"+(err&&err.message?escapeHtml(err.message):escapeHtml(String(err)))+"</td></tr></tbody>";
    console.error(err);
  }
}

/* --------------------- Init --------------------- */
(function init(){
  resolveConfigSync();
  var start = (CFG.ui && (CFG.ui.startMode==="json"||CFG.ui.startMode==="md")) ? CFG.ui.startMode : "md";
  if(!localStorage.getItem("viewMode")) VIEW_MODE = start;
  reloadAll();
})();
</script>
</body>
</html>
