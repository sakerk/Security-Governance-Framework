<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tool Disclosure List</title>
  <style>
    :root {
      --bg:#0b0f14; --panel:#0f172a; --muted:#93a1b1; --text:#e6edf3; --line:#1f2937;
      --accent:#60a5fa; --sel:#19324d; --hover:#0f2236; --danger:#ef4444; --ok:#22c55e;
      --gutter:#1f2937; --sidebg:#0b1220;
    }
    html, body { height:100%; }
    body {
      margin:0; background:var(--bg); color:var(--text);
      font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    .app { height:100vh; display:flex; flex-direction:column; }
    .topbar {
      position:sticky; top:0; z-index:20;
      display:flex; gap:10px; align-items:center; padding:10px 12px;
      background:var(--panel); border-bottom:1px solid var(--line);
    }
    .title { margin:0; font-size:16px; font-weight:600; letter-spacing:.2px; white-space:nowrap; }
    .spacer { flex:1; }
    .search {
      min-width:220px; max-width:420px; width:36ch;
      padding:10px 12px; border-radius:12px; outline:none;
      border:1px solid #263241; background:#0b1220; color:var(--text);
    }
    .count { font-size:12px; color:var(--muted); white-space:nowrap; }
    .exportWrap, .columnsWrap, .modeWrap { display:flex; gap:8px; align-items:center; position:relative; }
    .select, .btn {
      appearance:none; border:1px solid #27415f; background:#0f213c; color:#dbeafe;
      padding:10px 12px; border-radius:12px; cursor:pointer;
    }
    .btn:hover { background:#15325d; }
    .btn.primary { background:#13305a; border-color:#2d4c7b; }
    .select { min-width:150px; }
    .colsBtn { white-space:nowrap; }
    .colsPanel {
      display:none; position:absolute; top:42px; right:0; z-index:1000;
      min-width:260px; max-height:60vh; overflow:auto;
      background:#0b1220; border:1px solid #263241; border-radius:12px; padding:10px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .colsPanel.open { display:block; }
    .colsPanel label { display:flex; align-items:center; gap:8px; padding:6px 4px; cursor:pointer; }
    .colsPanel .note { margin-top:8px; color:var(--muted); font-size:12px; }

    .wrap { flex:1 1 auto; min-height:0; padding:10px; }
    .split { height:100%; display:flex; min-width:0; gap:0; }

    .leftPane { flex:1 1 auto; min-width:0; display:flex; }
    .tableScroll {
      flex:1 1 auto; height:100%; overflow:auto; background:#0b1220;
      border:1px solid #263241; border-radius:12px;
    }

    .gutter {
      width:6px; flex:0 0 auto; cursor:col-resize;
      background:linear-gradient(to right, transparent, var(--gutter), transparent);
      margin:0 8px;
    }

    .rightPane {
      width:var(--side-width, 360px); min-width:220px; max-width:70vw;
      background:var(--sidebg); border:1px solid #263241; border-radius:12px;
      display:flex; flex-direction:column; overflow:hidden;
    }
    .sideHeader {
      display:flex; align-items:center; gap:10px; padding:10px 12px;
      border-bottom:1px solid var(--line); background:#0f172a;
    }
    .sideTitle { font-weight:600; }
    .sideBody { flex:1 1 auto; overflow:auto; padding:12px; }

    .chkSection { margin-bottom:16px; }
    .chkSection h3 { margin:0 0 8px 0; font-size:14px; color:#cbd5e1; }
    .chkList { display:flex; flex-direction:column; gap:6px; }
    .chkItem { display:flex; align-items:flex-start; gap:8px; }
    .chkItem input { margin-top:2px; }
    .chkItem label { white-space:pre-wrap; }

    table { width:100%; border-collapse:separate; border-spacing:0; table-layout:fixed; }
    th, td { padding:10px 12px; border-bottom:1px solid var(--line); text-align:left; vertical-align:top; }
    td { white-space:pre-wrap; }
    thead th { position:sticky; top:0; background:#0f172a; z-index:1; user-select:none; }
    thead th.dragging { opacity:.6; }
    tbody tr.hide { display:none; }
    tbody tr.selected td { background:var(--sel); }
    tbody tr.focused td { outline:1px dashed var(--accent); outline-offset:-3px; }
    tbody tr:hover td { background:var(--hover); }
    tbody tr.selected:hover td { background:var(--sel); }
    th.selCol, td.selCol { width:44px; min-width:44px; max-width:44px; text-align:center; }
    input[type="checkbox"]{ width:16px; height:16px; cursor:pointer; }

    .resizer {
      position:absolute; top:0; right:-4px; width:8px; height:100%;
      cursor:col-resize; user-select:none;
      background:linear-gradient(to right, transparent 0, transparent 3px, #1f2937 3px, #1f2937 5px, transparent 5px);
      opacity:.3;
    }
    th { position:sticky; top:0; background:#0f172a; }
    th .headerInner { position:relative; display:flex; gap:6px; align-items:center; padding-right:10px; cursor:pointer; }
    .sortIndicator { font-size:12px; color:#9aa6b2; }
    .hide-col { display:none !important; }

    .seg { display:inline-flex; border:1px solid #27415f; border-radius:12px; overflow:hidden; }
    .seg button { border:0; background:#0f213c; color:#dbeafe; padding:8px 12px; cursor:pointer; }
    .seg button.active { background:#13305a; }

    @media (max-width:900px){
      .title { display:none; }
      .search { flex:1; min-width:0; width:auto; }
      .select { display:none; }
      .rightPane { display:none; } /* tuck away on small screens */
      .gutter { display:none; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="topbar">
      <h1 id="pageTitle" class="title">Tool Disclosure List</h1>

      <div class="modeWrap" title="Choose file type to view/save">
        <div class="seg" role="tablist" aria-label="View mode">
          <button id="modeMd"   role="tab" aria-selected="true">Markdown</button>
          <button id="modeJson" role="tab" aria-selected="false">JSON</button>
        </div>
      </div>

      <input id="q" class="search" type="search" placeholder="Search…" aria-label="Search table" />

      <div class="columnsWrap">
        <button id="colsBtn" class="btn colsBtn">Columns ▾</button>
        <div id="colsPanel" class="colsPanel" role="dialog" aria-label="Toggle columns"></div>
      </div>

      <div class="exportWrap">
        <button id="addBtn" class="btn primary">+ Add Row</button>
        <select id="fmt" class="select" aria-label="Export format">
          <option value="md">Markdown (.md)</option>
          <option value="csv">CSV (.csv)</option>
          <option value="json">JSON (.json)</option>
        </select>
        <button id="exportBtn" class="btn">Export</button>
        <button id="copyBtn" class="btn">Copy Row</button>
      </div>

      <div class="spacer"></div>
      <span id="count" class="count" aria-live="polite"></span>
    </header>

    <div class="wrap">
      <div class="split">
        <div class="leftPane">
          <div class="tableScroll">
            <table id="sheet">
              <colgroup id="colgroup">
                <col class="col-sel">
              </colgroup>
            </table>
          </div>
        </div>
        <div id="gutter" class="gutter" title="Drag to resize"></div>
        <aside id="rightPane" class="rightPane">
          <div class="sideHeader">
            <div class="sideTitle">Checklist</div>
            <button id="copyRowBtn" class="btn">Copy Row</button>
          </div>
          <div id="sideBody" class="sideBody">
            <div class="chkSection">
              <h3>BEST PRACTICES</h3>
              <div id="bpList" class="chkList"></div>
            </div>
            <div class="chkSection">
              <h3>ADDITIONAL RECOMMENDATIONS</h3>
              <div id="arList" class="chkList"></div>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </div>

  <!-- Add Row Modal -->
  <div id="addModal" class="modalBackdrop" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal" role="document">
      <header>
        <h2>Add Row</h2>
        <button id="addClose" class="btn">Close</button>
      </header>
      <div class="content">
        <form id="addForm">
          <div id="addGrid" class="grid"></div>
          <p class="help">All fields are optional. Leave blank to insert an empty cell.</p>
        </form>
      </div>
      <footer>
        <div id="addMsg" class="msg" aria-live="polite"></div>
        <button id="addCancel" class="btn">Cancel</button>
        <button id="addSave" class="btn primary">Save</button>
      </footer>
    </div>
  </div>

  <script>
    // ---- Config ----
    const GH_OWNER  = "sakerk";
    const GH_REPO   = "AI-Tool-Disclosure-List";
    const GH_BRANCH = "main";
    const DATA_DIR  = "data";

    let GH_TOKEN   = localStorage.getItem("ghToken") || "";
    let VIEW_MODE  = localStorage.get
